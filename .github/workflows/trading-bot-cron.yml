name: Trading Bot Update

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  update-trading-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 4  # Reduced from 5 to ensure quick failure if API is slow
    permissions:
      contents: write  # Required to push commits back to repository
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch full history for proper git operations
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Call Trading Bot Update API
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          set -e
          
          # Validate required secrets
          if [ -z "$VERCEL_URL" ]; then
            echo "âŒ Error: VERCEL_URL secret is not set in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "âŒ Error: CRON_SECRET secret is not set in GitHub Secrets"
            exit 1
          fi
          
          # Ensure VERCEL_URL has protocol
          if [[ ! "$VERCEL_URL" =~ ^https?:// ]]; then
            VERCEL_URL="https://${VERCEL_URL}"
          fi
          
          # Construct the API endpoint URL
          API_ENDPOINT="${VERCEL_URL}/api/trading/paper/cron-update"
          
          echo "ğŸ”— Calling API: ${API_ENDPOINT}"
          echo "ğŸ” Using CRON_SECRET: ${CRON_SECRET:0:4}... (hidden)"
          
          # Retry logic: try up to 3 times with exponential backoff
          MAX_RETRIES=3
          RETRY_DELAY=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # Use a temporary file to capture both response and exit code
            TEMP_FILE=$(mktemp)
            HTTP_CODE_FILE=$(mktemp)
            
            # Run curl with better error handling
            # Reduced timeouts for faster failure detection (API should respond quickly)
            CURL_EXIT_CODE=0
            curl -f -s -w "\nHTTP_STATUS:%{http_code}" \
              --max-time 25 \
              --connect-timeout 8 \
              -X GET \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              "${API_ENDPOINT}" \
              > "$TEMP_FILE" 2>&1 || CURL_EXIT_CODE=$?
            
            # Extract HTTP status code and body
            HTTP_STATUS=$(grep "HTTP_STATUS" "$TEMP_FILE" | cut -d: -f2 || echo "")
            BODY=$(grep -v "HTTP_STATUS" "$TEMP_FILE" || echo "")
            
            # Check if curl succeeded
            if [ $CURL_EXIT_CODE -eq 0 ] && [ -n "$HTTP_STATUS" ]; then
              echo "âœ… Response received (HTTP $HTTP_STATUS)"
              echo "Response Body: $BODY"
              
              # Check HTTP status
              if [ "$HTTP_STATUS" -eq 200 ]; then
                echo "âœ… Trading bot update completed successfully"
                rm -f "$TEMP_FILE" "$HTTP_CODE_FILE"
                exit 0
              elif [ "$HTTP_STATUS" -eq 401 ]; then
                echo "âš ï¸  Unauthorized (401) - CRON_SECRET may be incorrect or endpoint requires different auth"
                echo "Response Body: $BODY"
                rm -f "$TEMP_FILE" "$HTTP_CODE_FILE"
                exit 0  # Don't fail on 401 - might be expected if no active session
              elif [ "$HTTP_STATUS" -eq 500 ]; then
                echo "âŒ Server error (500) - API endpoint encountered an error"
                echo "Response Body: $BODY"
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "ğŸ”„ Retrying in ${RETRY_DELAY} seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                  sleep $RETRY_DELAY
                  RETRY_DELAY=$((RETRY_DELAY * 2))  # Exponential backoff
                fi
              else
                echo "âŒ Trading bot update failed with status $HTTP_STATUS"
                echo "Response Body: $BODY"
                rm -f "$TEMP_FILE" "$HTTP_CODE_FILE"
                exit 1
              fi
            else
              # Curl failed (network error, timeout, etc.)
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âŒ Network error (curl exit code: $CURL_EXIT_CODE)"
              echo "Error details: $BODY"
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ”„ Retrying in ${RETRY_DELAY} seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))  # Exponential backoff
              else
                echo "âŒ Failed after $MAX_RETRIES attempts"
                echo "ğŸ’¡ Troubleshooting tips:"
                echo "   1. Verify VERCEL_URL is correct in GitHub Secrets"
                echo "   2. Ensure the Vercel deployment is accessible"
                echo "   3. Check if the API endpoint path is correct"
                echo "   4. Verify network connectivity from GitHub Actions"
                rm -f "$TEMP_FILE" "$HTTP_CODE_FILE"
                exit 1
              fi
            fi
            
            rm -f "$TEMP_FILE" "$HTTP_CODE_FILE"
          done
          
          # Should not reach here, but just in case
          exit 1
      
      - name: Detect and fill missing candles
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          if [ -z "$REDIS_URL" ]; then
            echo "âš ï¸  REDIS_URL not set - skipping gap detection/filling"
            echo "   (This is optional - cron job still updated prices)"
            exit 0
          fi
          echo "ğŸ” Detecting and filling missing candles for ETH and BTC (8h, 1d, 12h)..."
          echo "ğŸ”— Connecting to Redis (URL: ${REDIS_URL:0:30}...)"
          pnpm detect-missing-candles || {
            echo "âš ï¸  Gap detection/filling completed with warnings or errors"
            # Continue even if there are warnings - API update was successful
            exit 0
          }
      
      - name: Check for file changes
        id: git-check
        run: |
          # Check specifically for changes in data/historical-prices/
          if [ -n "$(git status --porcelain data/historical-prices/)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Missing candles were filled and files updated in data/historical-prices/"
            git status --short data/historical-prices/
            echo ""
            echo "Changed files:"
            git diff --name-only data/historical-prices/ || true
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No file changes (no missing candles found or already in files)"
          fi
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          echo "ğŸ“¦ Staging changes in data/historical-prices/"
          git add data/historical-prices/
          
          echo "ğŸ“ Committing changes..."
          git commit -m "chore: fill missing candles detected by cron job [skip ci]" || {
            echo "âš ï¸  Commit failed - files may have been identical or already committed"
            exit 0
          }
          
          echo "ğŸ“Š Commit details:"
          git log -1 --stat
          
          echo "ğŸš€ Pushing to origin/main..."
          git push origin HEAD:main || {
            echo "âŒ Failed to push changes"
            echo "ğŸ’¡ This may be due to:"
            echo "   1. GITHUB_TOKEN permissions (check workflow permissions)"
            echo "   2. Branch protection rules (may need to use pull request)"
            echo "   3. Network issues"
            echo ""
            echo "âš ï¸  Changes are committed locally but not pushed - they will be lost on next deploy!"
            exit 1  # Fail the workflow if push fails - this is critical
          }
          echo "âœ… Changes committed and pushed to repository"

